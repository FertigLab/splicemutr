---

title: "analysis_Theron_08262021"
author: "Theron Palmer"
date: "8/26/2021"
output:
  html_document:
    toc: yes
    toc_float: yes
    
---

# Analysis Pipeline

On ZAPPA. recount3_tcga_juncs_prep.sh -> recount3_tcga_juncs.sh -> splicemutr_leafcutter.sh -> save_introns.sh -> cong_tcga_junc.R -> tcga_form_transcripts.sh -> process_peps.sh -> runMHCnuggets.sh -> process_percentile.sh -> create_genotypes.sh (TCGA_assign_imm.sh) -> TCGA_assign_imm_py.sh -> TCGA_combine_kmers.sh -> create_junc_expr.sh -> TCGA_gene_expr_per_sample.sh -> calc_gene_metric.sh

create_TCGA_TMB_maf_summary.sh

# Loading in necessary libraries

```{r,echo=FALSE}

library(dplyr)
library(knitr)
library(ggplot2)
library(TCGAutils)
library(maftools)
library(ggpubr)
library(stringr)
library(readxl)
library(ComplexHeatmap)
library(recount3)
library(DT)
library(rstatix)
library(ggrepel)
library(ggprism)

```

```{r}

mod_path <- function(path){ # requires path to be pulled from external mounted through wsl
  str_replace_all(path,"/mnt/f","F:")
}

graph_plot_SF_genes <- function(combined_gene_metric_per_sample_all_small){
  MUT_VALS<-length(which(combined_gene_metric_per_sample_all_small$SF3B1=="MUT"))
    WT_VALS<-length(which(combined_gene_metric_per_sample_all_small$SF3B1=="WT"))
    if (MUT_VALS>0 & WT_VALS>0){
      wixoc_test_val <- compare_means(splicing_antigenicity ~ SF3B1,comparisons = my_comparisons, p.adjust.method = "BH", data=combined_gene_metric_per_sample_all_small)
      print(ggplot(combined_gene_metric_per_sample_all_small,aes(y=splicing_antigenicity,x=SF3B1))+
      geom_boxplot(fill="grey")+geom_violin(alpha=0.2)+
        stat_pvalue_manual(wixoc_test_val, 
    y.position = max(combined_gene_metric_per_sample_all_small$splicing_antigenicity)+(max(combined_gene_metric_per_sample_all_small$splicing_antigenicity)/2),
    label = "p.adj" )+
      labs(title=sprintf("%s: MUT=%d,WT=%d",cancer,MUT_VALS,WT_VALS))+
        ylab("splicing antigenicity"))
    } else {
      print(ggplot(combined_gene_metric_per_sample_all_small,aes(y=splicing_antigenicity,x=SF3B1))+
      geom_boxplot(fill="grey")+geom_violin(alpha=0.2)+
      labs(title=sprintf("%s: MUT=%d,WT=%d",cancer,MUT_VALS,WT_VALS))+
        ylab("splicing antigenicity"))
    }

    MUT_VALS<-length(which(combined_gene_metric_per_sample_all_small$U2AF1=="MUT"))
    WT_VALS<-length(which(combined_gene_metric_per_sample_all_small$U2AF1=="WT"))
    if (MUT_VALS>0 & WT_VALS>0){
      wixoc_test_val <- compare_means(splicing_antigenicity ~ U2AF1,comparisons = my_comparisons, p.adjust.method = "BH", data=combined_gene_metric_per_sample_all_small)
      print(ggplot(combined_gene_metric_per_sample_all_small,aes(y=splicing_antigenicity,x=U2AF1))+
      geom_boxplot(fill="grey")+geom_violin(alpha=0.2)+
        stat_pvalue_manual(wixoc_test_val, 
    y.position = max(combined_gene_metric_per_sample_all_small$splicing_antigenicity)+(max(combined_gene_metric_per_sample_all_small$splicing_antigenicity)/2),
    label = "p.adj" )+
      labs(title=sprintf("%s: MUT=%d,WT=%d",cancer,MUT_VALS,WT_VALS))+
        ylab("splicing antigenicity"))
    } else {
      print(ggplot(combined_gene_metric_per_sample_all_small,aes(y=splicing_antigenicity,x=U2AF1))+
      geom_boxplot(fill="grey")+
      labs(title=sprintf("%s: MUT=%d,WT=%d",cancer,MUT_VALS,WT_VALS))+
        ylab("splicing antigenicity"))
    }

        
    MUT_VALS<-length(which(combined_gene_metric_per_sample_all_small$SRSF2=="MUT"))
    WT_VALS<-length(which(combined_gene_metric_per_sample_all_small$SRSF2=="WT"))
    if (MUT_VALS>0 & WT_VALS>0){
      wixoc_test_val <- compare_means(splicing_antigenicity ~ SRSF2,comparisons = my_comparisons, p.adjust.method = "BH", data=combined_gene_metric_per_sample_all_small)
      print(ggplot(combined_gene_metric_per_sample_all_small,aes(y=splicing_antigenicity,x=SRSF2))+
      geom_boxplot(fill="grey")+geom_violin(alpha=0.2)+
        stat_pvalue_manual(wixoc_test_val, 
    y.position = max(combined_gene_metric_per_sample_all_small$splicing_antigenicity)+(max(combined_gene_metric_per_sample_all_small$splicing_antigenicity)/2),
    label = "p.adj" )+
      labs(title=sprintf("%s: MUT=%d,WT=%d",cancer,MUT_VALS,WT_VALS))+
        ylab("splicing antigenicity"))
    } else {
      print(ggplot(combined_gene_metric_per_sample_all_small,aes(y=splicing_antigenicity,x=SRSF2))+
      geom_boxplot(fill="grey")+geom_violin(alpha=0.2)+
      labs(title=sprintf("%s: MUT=%d,WT=%d",cancer,MUT_VALS,WT_VALS))+
        ylab("splicing antigenicity"))
    }
}

```

# Accumulating mutation data per sample only annotated

## Preparing TCGA cibersort data [1]

```{r}

TCGA_cibersort_all <- read.table(mod_path("/mnt/f/TCGA_junctions/ext_dat/the_Immune_Landscape_of_Cancer/TCGA.Kallisto.fullIDs.cibersort.relative.tsv"),header=T)
TCGA_cibersort_all$barcode <- str_replace_all(TCGA_cibersort_all$SampleID,"[.]","-")
TCGA_cibersort_all$sample_ID <- vapply(TCGAbarcode(TCGA_cibersort_all$barcode,sample=T),
                                       function(val){substr(val,1,nchar(val)-1)},character(1))
TCGA_cibersort_all$patient_ID <- TCGAbarcode(TCGA_cibersort_all$barcode)
TCGA_cibersort_all <- TCGA_cibersort_all[as.numeric(TCGA_cibersort_all$P.value)<=0.05,]
cibersort_cells <- c("SampleID","B.cells.naive","B.cells.memory","Plasma.cells",
                     "T.cells.CD8","T.cells.CD4.naive","T.cells.CD4.memory.resting",
                     "T.cells.CD4.memory.activated","T.cells.follicular.helper",
                     "T.cells.regulatory..Tregs.","T.cells.gamma.delta","NK.cells.resting",
                     "NK.cells.activated","Monocytes","Macrophages.M0","Macrophages.M1",
                     "Macrophages.M2","Dendritic.cells.resting","Dendritic.cells.activated",
                     "Mast.cells.resting","Mast.cells.activated","Eosinophils","Neutrophils","P.value","Correlation","RMSE",
                     "barcode","sample_ID","patient_ID")
actual_cibersort_cells <- c("B.cells.naive","B.cells.memory","Plasma.cells",
                     "T.cells.CD8","T.cells.CD4.naive","T.cells.CD4.memory.resting",
                     "T.cells.CD4.memory.activated","T.cells.follicular.helper",
                     "T.cells.regulatory..Tregs.","T.cells.gamma.delta","NK.cells.resting",
                     "NK.cells.activated","Monocytes","Macrophages.M0","Macrophages.M1",
                     "Macrophages.M2","Dendritic.cells.resting","Dendritic.cells.activated",
                     "Mast.cells.resting","Mast.cells.activated","Eosinophils","Neutrophils")

```

## Preparing non-silent mutation load [1]

```{r}

# contains sample id minus the last letter, or rather the vial code

mutation_load_file <- mod_path("/mnt/f/TCGA_junctions/ext_dat/the_Immune_Landscape_of_Cancer/mutation-load_updated.txt")
mutation_load <- read.table(mutation_load_file,sep="\t",header=T)
colnames(mutation_load)<-c("cohort","patient_ID","sample_ID","silent_per_mb","non_silent_per_mb")

TMB_vals <- data.frame(median_TMB = vapply(unique(mutation_load$cohort),
                              function(cohort){median(mutation_load$non_silent_per_mb[mutation_load$cohort==cohort])},numeric(1)))
TMB_vals <- TMB_vals[order(TMB_vals$median_TMB),,drop=F]
mutation_load$cohort <- factor(mutation_load$cohort,levels=rownames(TMB_vals))

ggplot(mutation_load,aes(x=cohort,y=log10(non_silent_per_mb+1)))+
  geom_boxplot()+geom_violin(alpha=0.2,fill="grey")+
  theme(axis.text.x = element_text(angle = 90))+
  ylab("log10(Non silent mutations per Mb)")+
  geom_hline(yintercept=log10(10))+
  xlab("TCGA Cohort")

num_samples <- data.frame(table(mutation_load$cohort))
datatable(num_samples)

```

## Preparing Leuokocyte Fraction Data [1]

```{r}

leukocyte_fraction_file <- mod_path("/mnt/f/TCGA_junctions/ext_dat/the_Immune_Landscape_of_Cancer/TCGA_all_leuk_estimate.masked.20170107.tsv")
leukocyte_fraction <- read.table(leukocyte_fraction_file,sep="\t",header=F)
colnames(leukocyte_fraction)<-c("cohort","barcode","fraction")
leukocyte_fraction$patient_ID <- TCGAbarcode(leukocyte_fraction$barcode)
leukocyte_fraction$sample_ID <- vapply(TCGAbarcode(leukocyte_fraction$barcode,sample=T),
                                       function(val){substr(val,1,nchar(val)-1)},character(1))

leuk_vals <- data.frame(median_LF = vapply(unique(leukocyte_fraction$cohort),
                              function(cohort){median(leukocyte_fraction$fraction[leukocyte_fraction$cohort==cohort])},numeric(1)))
leuk_vals <- leuk_vals[order(leuk_vals$median_LF),,drop=F]
leukocyte_fraction$cohort <- factor(leukocyte_fraction$cohort,levels=rownames(leuk_vals))


ggplot(leukocyte_fraction,aes(x=cohort,y=fraction))+
  geom_boxplot()+geom_violin(alpha=0.2,fill="grey")+
  theme(axis.text.x = element_text(angle = 90))+
  xlab("TCGA Cohort")+
  ylab("Leukocyte Fraction")

```

## Preparing Immunogenic SNV Data [1]

```{r}

binding_snv_file <- mod_path("/mnt/f/TCGA_junctions/ext_dat/the_Immune_Landscape_of_Cancer/TCGA_pMHC_SNV_sampleSummary_MC3_v0.2.8.CONTROLLED_170404.tsv")
binding_snv <- read.table(binding_snv_file,sep="\t",header=T)
binding_snv$patient_ID <- TCGAbarcode(binding_snv$barcode)
binding_snv$sample_ID <- vapply(TCGAbarcode(binding_snv$barcode,sample=T),
                                       function(val){substr(val,1,nchar(val)-1)},character(1))


```

## Preparing TCR clonality data [1]

```{r}

tcr_clonality_file <-  mod_path("/mnt/f/TCGA_junctions/ext_dat/the_Immune_Landscape_of_Cancer/mitcr_sampleStatistics_20160714.tsv")
tcr_clonality <-  read.table(tcr_clonality_file,sep="\t",header=T)
tcr_clonality$sample_ID <- vapply(TCGAbarcode(tcr_clonality$AliquotBarcode,sample=T),
                                       function(val){substr(val,1,nchar(val)-1)},character(1))

tcr_clonality_vals <- data.frame(median_tcr = vapply(unique(tcr_clonality$Study),
                              function(Study){median(tcr_clonality$numClones[tcr_clonality$Study==Study])},numeric(1)))
tcr_clonality_vals <- tcr_clonality_vals[order(tcr_clonality_vals$median_tcr),,drop=F]
tcr_clonality$Study <- factor(tcr_clonality$Study,levels=rownames(tcr_clonality_vals))

ggplot(tcr_clonality,aes(x=Study,y=log10(numClones+1)))+
  geom_boxplot()+geom_violin(alpha=0.2,fill="grey")+
  theme(axis.text.x = element_text(angle = 90))+
  xlab("TCGA Cohort")+
  ylab("log10(Number of TCR Clones)")

```

## Preparing viral data [1]

```{r}

viral_expression_file <-  mod_path("/mnt/f/TCGA_junctions/ext_dat/the_Immune_Landscape_of_Cancer/viral.tsv")
viral_expression <-  read.table(viral_expression_file,sep="\t",header=T)
viral_expression <- viral_expression[viral_expression$HPV>1 & viral_expression$Study=="HNSC",]
viral_expression$sample_ID <- vapply(TCGAbarcode(viral_expression$AliquotBarcode,sample=T),
                                       function(val){substr(val,1,nchar(val)-1)},character(1))

```

```{r}

indel_burden_file <- mod_path("/mnt/f/TCGA_junctions/ext_dat/the_Immune_Landscape_of_Cancer/TCGA_PCA.mc3.v0.2.8.CONTROLLED.filtered.sample_neoantigens_10062017.tsv")
indel_burden <-  read.table(indel_burden_file,sep="\t",header=T)

```


## Preparing splicemutr data

```{r,eval=F}

# this really only needs to be run once on your system

tumor_data_file <- mod_path("/mnt/f/TCGA_junctions/TCGA_cancers/JHPCE/cancer_dirs_filt.txt")
tumor_data <- read.table(tumor_data_file)
cancers <- c(tumor_data$V1)

splicing_antigenicity_tum <- data.frame(cancers)

TMB_all_cor <- data.frame(cancers)
rownames(TMB_all_cor) <- cancers
TMB_all_pvals <- data.frame(cancers)
rownames(TMB_all_pvals) <- cancers
DA_all_cor <- data.frame(cancers)
rownames(DA_all_cor) <- cancers
DA_all_pvals <- data.frame(cancers)
rownames(DA_all_pvals) <- cancers
cibersort_all_pvals <- data.frame(cancers)
rownames(cibersort_all_pvals)<-cancers
cibersort_all_cor <- data.frame(cancers)
rownames(cibersort_all_cor)<-cancers
all_genes <- c()

TCGA_ROOT_DIR=mod_path("/mnt/f/TCGA_junctions/TCGA_cancers")
dups <- c()
for (i in seq(length(cancers))){
  cancer <- cancers[i]
  print(sprintf("%s: %d out of %d",cancer,i,length(cancers)))
  tumor_geno <- read.table(sprintf("%s/%s/JHPCE/%s_genotypes_specific.txt",TCGA_ROOT_DIR,cancer,cancer),header=T)
  tumor_geno$sample_ID <- vapply(TCGAbarcode(tumor_geno$aliquot_id,sample=T),
                                       function(val){substr(val,1,nchar(val)-1)},character(1))
  tumor_geno$patient_ID <- TCGAbarcode(tumor_geno$aliquot_id)
  normal_samples <- tumor_geno$external_id[tumor_geno$type=="N"]
  tumor_samples <- tumor_geno$external_id[tumor_geno$type=="T"]

  tumor_geno <- tumor_geno %>% dplyr::filter(type=="T")
  tumor_geno <- tumor_geno[complete.cases(tumor_geno),]

  # creating the splicing antigenicity for tumor splicing events
  splice_mut_file <- sprintf("%s/%s/JHPCE/GENE_METRIC_CP/SA_tumor.txt",TCGA_ROOT_DIR,cancer)
  splice_mut_files <- read.table(splice_mut_file)
  for (j in seq(length(splice_mut_files$V1))){ # splicing antigenicity
    if (j == 1){
      combined_gene_metric_tumor <- readRDS(mod_path(splice_mut_files$V1[j]))
    } else {
      a<-readRDS(mod_path(splice_mut_files$V1[j]))
      combined_gene_metric_tumor <- cbind(combined_gene_metric_tumor,a)
    }
  }
  CP_file <- str_replace(splice_mut_files$V1[1],"gene_metric_mean_len_norm_no_gene_norm_tumor","coding_potential_LGC_tumor")
  coding_potential_LGC_tumor <- readRDS(mod_path(CP_file))
  HIGH_CP_GENES <- rownames(coding_potential_LGC_tumor)[coding_potential_LGC_tumor$coding_potential_LGC>0]

  # creating the splicing antigenicity for normal splicing events
  splice_mut_file <- sprintf("%s/%s/JHPCE/GENE_METRIC_CP/SA_normal.txt",TCGA_ROOT_DIR,cancer)
  splice_mut_files <- read.table(splice_mut_file)
  for (j in seq(length(splice_mut_files$V1))){ 
    if (j == 1){
      combined_gene_metric_normal <- readRDS(mod_path(splice_mut_files$V1[j]))
    } else {
      a<-readRDS(mod_path(splice_mut_files$V1[j]))
      combined_gene_metric_normal <- cbind(combined_gene_metric_normal,a)
    }
  }
  
  combined_gene_metric_tumor <- combined_gene_metric_tumor[,tumor_samples[tumor_samples %in% colnames(combined_gene_metric_tumor)]]
  combined_gene_metric_normal <- combined_gene_metric_normal[,normal_samples[normal_samples %in% colnames(combined_gene_metric_normal)]]
  conglomerate_genes <- unique(rownames(combined_gene_metric_tumor),rownames(combined_gene_metric_normal))
  
  normal_all <- combined_gene_metric_normal[conglomerate_genes,
                                            normal_samples[normal_samples %in% colnames(combined_gene_metric_normal)]]
  normal_all[is.na(normal_all)]<-0
  normal_all_vec <- c()
  normal_filler<-vapply(seq(ncol(normal_all)),function(col_val){
    normal_all_vec <<- c(normal_all_vec,normal_all[,col_val])
    return(T)
  },logical(1))
  normal_all <- data.frame(SA=normal_all_vec,gene=rep(conglomerate_genes,ncol(normal_all)))
normal_all$type<-"normal"

  tumor_all <- combined_gene_metric_tumor[conglomerate_genes,tumor_samples[tumor_samples %in% colnames(combined_gene_metric_tumor)]]
  tumor_all[is.na(tumor_all)]<-0
  tumor_all_vec <- c()
  tumor_filler<-vapply(seq(ncol(tumor_all)),function(col_val){
    tumor_all_vec <<- c(tumor_all_vec,tumor_all[,col_val])
    return(T)
  },logical(1))
  tumor_all <- data.frame(SA=tumor_all_vec,gene=rep(conglomerate_genes,ncol(tumor_all)))
tumor_all$type<-"tumor"

  tumor_normal_all <- rbind(tumor_all,normal_all)
  wilcox_test_val_all <- compare_means(SA ~ type, p.adjust.method = "BH", data=tumor_normal_all,group.by = c("gene"))
  diff_sig_genes <- wilcox_test_val_all$gene[wilcox_test_val_all$p.adj<0.05]
  conglomerate_genes <- intersect(conglomerate_genes,diff_sig_genes)
  
  combined_gene_metric_tumor <- combined_gene_metric_tumor[conglomerate_genes,]
  combined_gene_metric_tumor[is.na(combined_gene_metric_tumor)]<-0
  combined_gene_metric_normal <- combined_gene_metric_normal[conglomerate_genes,]
  combined_gene_metric_normal[is.na(combined_gene_metric_normal)]<-0
  
  combined_gene_metric_tumor_mean <- apply(combined_gene_metric_tumor,1,mean,na.rm=T)
  combined_gene_metric_normal_mean <- apply(combined_gene_metric_normal,1,mean,na.rm=T)
  combined_gene_metric_DA <- data.frame(DA=(combined_gene_metric_tumor_mean)/(combined_gene_metric_normal_mean),
                                        DA_inv=(combined_gene_metric_normal_mean)/(combined_gene_metric_tumor_mean))
  
  combined_gene_metric_DA$cancer <- cancer
  combined_gene_metric_DA$DA[combined_gene_metric_DA$DA==Inf & !is.na(combined_gene_metric_DA$DA)]<-sample(combined_gene_metric_DA$DA[combined_gene_metric_DA$DA!=Inf & !is.na(combined_gene_metric_DA$DA) & combined_gene_metric_DA$DA > 1],length(which(combined_gene_metric_DA$DA==Inf & !is.na(combined_gene_metric_DA$DA))),replace=T)
  
  combined_gene_metric_DA$DA[combined_gene_metric_DA$DA_inv==Inf & !is.na(combined_gene_metric_DA$DA_inv)]<-sample(combined_gene_metric_DA$DA[combined_gene_metric_DA$DA_inv!=Inf & !is.na(combined_gene_metric_DA$DA_inv) & combined_gene_metric_DA$DA_inv > 1],length(which(combined_gene_metric_DA$DA_inv==Inf & !is.na(combined_gene_metric_DA$DA_inv))),replace=T)
  combined_gene_metric_DA$genes <- rownames(combined_gene_metric_DA)

  if (i == 1){
    combined_gene_metric_DA_all <- combined_gene_metric_DA
    combined_gene_metric_tumor_all_genes <- data.frame(SA=unname(combined_gene_metric_tumor_mean),
                                                       cancer=rep(cancer,length(combined_gene_metric_tumor_mean)),
                                                       gene=conglomerate_genes)
    combined_gene_metric_tumor_all_samples <- data.frame(SA = apply(combined_gene_metric_tumor,2,mean),
                                                         cancer=rep(cancer,ncol(combined_gene_metric_tumor)),
                                                         type=rep("tumor",ncol(combined_gene_metric_tumor)))
    combined_gene_metric_normal_all_genes <- data.frame(SA=unname(combined_gene_metric_normal_mean),
                                                        cancer=rep(cancer,length(combined_gene_metric_normal_mean)),
                                                        gene=conglomerate_genes)
    combined_gene_metric_normal_all_samples <- data.frame(SA = apply(combined_gene_metric_normal,2,mean),
                                                     cancer=rep(cancer,ncol(combined_gene_metric_normal)),
                                                     type=rep("normal",ncol(combined_gene_metric_normal)))
  } else {
    combined_gene_metric_DA_all_fill <- combined_gene_metric_DA
    combined_gene_metric_tumor_all_genes_fill <- data.frame(SA=unname(combined_gene_metric_tumor_mean),
                                                       cancer=rep(cancer,length(combined_gene_metric_tumor_mean)),
                                                       gene=conglomerate_genes)
    combined_gene_metric_tumor_all_samples_fill <- data.frame(SA = apply(combined_gene_metric_tumor,2,mean),
                                                         cancer=rep(cancer,ncol(combined_gene_metric_tumor)),
                                                         type=rep("tumor",ncol(combined_gene_metric_tumor)))
    combined_gene_metric_normal_all_genes_fill <- data.frame(SA=unname(combined_gene_metric_normal_mean),
                                                        cancer=rep(cancer,length(combined_gene_metric_normal_mean)),
                                                        gene=conglomerate_genes)
    combined_gene_metric_normal_all_samples_fill <- data.frame(SA = apply(combined_gene_metric_normal,2,mean),
                                                     cancer=rep(cancer,ncol(combined_gene_metric_normal)),
                                                     type=rep("normal",ncol(combined_gene_metric_normal)))
    
    combined_gene_metric_DA_all <- rbind(combined_gene_metric_DA_all,combined_gene_metric_DA_all_fill)
    combined_gene_metric_tumor_all_genes <- rbind(combined_gene_metric_tumor_all_genes,combined_gene_metric_tumor_all_genes_fill)
    combined_gene_metric_tumor_all_samples <- rbind(combined_gene_metric_tumor_all_samples,combined_gene_metric_tumor_all_samples_fill)
    combined_gene_metric_normal_all_genes <- rbind(combined_gene_metric_normal_all_genes,combined_gene_metric_normal_all_genes_fill)
    combined_gene_metric_normal_all_samples <- rbind(combined_gene_metric_normal_all_samples,combined_gene_metric_normal_all_samples_fill)
    
  }

  high_DA_genes <-  combined_gene_metric_DA[combined_gene_metric_DA$DA>0,"genes"]
  high_DA_genes <- high_DA_genes[!is.na(high_DA_genes)]
  HIGH_DA_HIGH_CP_genes <- intersect(intersect(high_DA_genes,HIGH_CP_GENES),diff_sig_genes)
  combined_gene_metric_tumor_HIGH_DA_HIGH_CP_diff_sig<-combined_gene_metric_tumor[HIGH_DA_HIGH_CP_genes,]

  colnames_combined_gene_metric <-colnames(combined_gene_metric_tumor_HIGH_DA_HIGH_CP_diff_sig)
  colnames(combined_gene_metric_tumor_HIGH_DA_HIGH_CP_diff_sig) <- vapply(colnames_combined_gene_metric,function(col_name){
    tumor_geno$sample_ID[which(tumor_geno$external_id == col_name)[1]]
  },character(1))
  combined_gene_metric_barcode <- vapply(colnames_combined_gene_metric,function(col_name){
    tumor_geno$aliquot_id[which(tumor_geno$external_id == col_name)[1]]
  },character(1))

  mutation_load_small <- mutation_load %>% dplyr::filter(sample_ID %in% colnames(combined_gene_metric_tumor_HIGH_DA_HIGH_CP_diff_sig))
  leukocyte_fraction_small <- leukocyte_fraction %>% dplyr::filter(sample_ID %in% colnames(combined_gene_metric_tumor_HIGH_DA_HIGH_CP_diff_sig))
  binding_snv_small <- binding_snv %>% dplyr::filter(sample_ID %in% colnames(combined_gene_metric_tumor_HIGH_DA_HIGH_CP_diff_sig))
  tcr_clonality_small <- tcr_clonality %>% dplyr::filter(sample_ID %in% colnames(combined_gene_metric_tumor_HIGH_DA_HIGH_CP_diff_sig))
  TCGA_cibersort_small <- TCGA_cibersort_all %>% dplyr::filter(sample_ID %in% colnames(combined_gene_metric_tumor_HIGH_DA_HIGH_CP_diff_sig))

  combined_gene_metric_per_sample<-data.frame(sample_ID=colnames(combined_gene_metric_tumor_HIGH_DA_HIGH_CP_diff_sig),
                                              barcode=combined_gene_metric_barcode)
  combined_gene_metric_per_sample$splicing_antigenicity <- vapply(seq(ncol(combined_gene_metric_tumor_HIGH_DA_HIGH_CP_diff_sig)),
                                               function(col_val){mean(as.numeric(combined_gene_metric_tumor_HIGH_DA_HIGH_CP_diff_sig[,col_val]),
                                                                      na.rm=T)},numeric(1))
  # combined_gene_metric_per_sample$splicing_antigenicity_max <- vapply(seq(ncol(combined_gene_metric_tumor_HIGH_DA_HIGH_CP_diff_sig)),
  #                                            function(col_val){max(as.numeric(combined_gene_metric_tumor_HIGH_DA_HIGH_CP_diff_sig[,col_val]),
  #                                                                   na.rm=T)},numeric(1))
  # combined_gene_metric_per_sample$splicing_antigenicity_median <- vapply(seq(ncol(combined_gene_metric_tumor_HIGH_DA_HIGH_CP_diff_sig)),
  #                                            function(col_val){median(as.numeric(combined_gene_metric_tumor_HIGH_DA_HIGH_CP_diff_sig[,col_val]),
  #                                                                   na.rm=T)},numeric(1))
  
  # I need to handle duplicate samples
  # print("mutation_load")
  combined_gene_metric_per_sample$non_silent_mutations_per_mb <- unlist(lapply(combined_gene_metric_per_sample$sample_ID,function(ID){
    a<-which(mutation_load_small$sample_ID==ID)
    if (length(a)==1){
      return(mutation_load_small$non_silent_per_mb[a])
    } else if (length(a)>1){
      dups<<-c(dups,ID)
      return(mutation_load_small$non_silent_per_mb[a[1]])
    } else {
      return(NA)
    }
  }))
  # print("leukocyte_fraction")
  combined_gene_metric_per_sample$leukocyte_fraction <- unlist(lapply(seq(length(combined_gene_metric_per_sample$sample_ID)),function(ID_num){
    ID<-combined_gene_metric_per_sample$sample_ID[ID_num]
    barcode<-combined_gene_metric_per_sample$barcode[ID_num]
    a<-which(leukocyte_fraction_small$sample_ID==ID)
    if (length(a)==1){
      return(leukocyte_fraction_small$fraction[a])
    } else if (length(a)>1){
      aa<-which(leukocyte_fraction$barcode==barcode)
      if (length(aa)==1){
        return(leukocyte_fraction_small$fraction[aa]) 
      } else if (length(aa)>1){
        dups<<-c(dups,ID)
        return(leukocyte_fraction_small$fraction[aa[1]])
      } else {
        return(NA)
      }
    } else {
      return(NA)
    }
  }))
  # print("numberOfImmunogenicMutation")
  combined_gene_metric_per_sample$numberOfImmunogenicMutation <- unlist(lapply(seq(length(combined_gene_metric_per_sample$sample_ID)),function(ID_num){
    ID<-combined_gene_metric_per_sample$sample_ID[ID_num]
    barcode<-combined_gene_metric_per_sample$barcode[ID_num]
    a<-which(binding_snv_small$sample_ID==ID)
    if (length(a)==1){
      return(binding_snv_small$numberOfImmunogenicMutation[a])
    } else if (length(a)>1){
      aa<-which(binding_snv_small$barcode==barcode)
      if (length(aa)==1){
        return(binding_snv_small$numberOfImmunogenicMutation[aa]) 
      } else if (length(aa)>1){
        dups<<-c(dups,ID)
        return(binding_snv_small$numberOfImmunogenicMutation[aa[1]])
      } else {
        return(NA)
      }
    } else  {
      return(NA)
    }
  }))

  # print("numClones")
  combined_gene_metric_per_sample$numClones <- unlist(lapply(seq(length(combined_gene_metric_per_sample$sample_ID)),function(ID_num){
    ID<-combined_gene_metric_per_sample$sample_ID[ID_num]
    barcode<-combined_gene_metric_per_sample$barcode[ID_num]
    a<-which(tcr_clonality$sample_ID==ID)
    if (length(a)==1){
      return(tcr_clonality$numClones[a])
    } else if (length(a)>1){
      aa<-which(tcr_clonality$AliquotBarcode==barcode)
      if (length(aa)==1){
        return(tcr_clonality$numClones[aa]) 
      } else if (length(aa)>1){
        dups<<-c(dups,ID)
        return(tcr_clonality$numClones[aa[1]])
      } else {
        return(NA)
      }
    } else {
      return(NA)
    }
  }))
  combined_gene_metric_per_sample$splicing_antigenicity_norm <- combined_gene_metric_per_sample$splicing_antigenicity/max(combined_gene_metric_per_sample$splicing_antigenicity)
  combined_gene_metric_per_sample$cancer <- cancer
  colnames(combined_gene_metric_per_sample) <- c("sample_ID","barcode","splicing_antigenicity","non_silent_mutations_per_mb",
                                                 "leukocyte_fraction","numberOfImmunogenicMutation",
                                                 "num_TCR_Clones","splicing_antigenicity_norm","cancer")
  combined_gene_metric_per_sample <- combined_gene_metric_per_sample[!(combined_gene_metric_per_sample$sample_ID %in% dups),]
  combined_gene_metric_per_sample$TMB_TYPE <- "LOW"
  combined_gene_metric_per_sample$TMB_TYPE <- unlist(lapply(combined_gene_metric_per_sample$non_silent_mutations_per_mb,function(val){
    if (is.na(val)){
      return(NA)
    } else if(val>=10){
      return("TMB HIGH")
    } else {
      return("TMB LOW")
    }}))
  # print("cibersort_per_samp")
  cibersort_per_samp <- lapply(seq(length(combined_gene_metric_per_sample$sample_ID)),
                             function(samp_num){
                               samp<-TCGA_cibersort_small$sample_ID[samp_num]
                               barcode <- TCGA_cibersort_small$barcode[samp_num]
                               a<-which(TCGA_cibersort_small$sample_ID==samp)
                               if (length(a)==1){
                                 return(TCGA_cibersort_small[a,cibersort_cells,drop=F])
                               } else if (length(a)>1){
                                 aa<-which(TCGA_cibersort_small$barcode==barcode)
                                 if (length(aa)==1){
                                   return(TCGA_cibersort_small[aa,cibersort_cells,drop=F])
                                 } else if (length(aa)>1){
                                   dups<<-c(dups,samp)
                                   return(TCGA_cibersort_small[aa[1],cibersort_cells,drop=F])
                                 } else {
                                   return(NA)
                                 }
                               } else {
                                a<-data.frame(t(rep(NA,length(cibersort_cells))))
                                colnames(a)<-cibersort_cells
                                return(a)
                              }
                             })
  cibersort_per_samp_df<-cibersort_per_samp[[1]]
  for (k in seq(2,length(cibersort_per_samp))){
    cibersort_per_samp_df <- rbind(cibersort_per_samp_df,cibersort_per_samp[[k]])
  }
  cibersort_per_samp_df <- cibersort_per_samp_df[complete.cases(cibersort_per_samp_df),]
  
  cibersort_cols_to_add <- c("splicing_antigenicity_norm","non_silent_mutations_per_mb","leukocyte_fraction",
                           "numberOfImmunogenicMutation","num_TCR_Clones",
                           "cancer")
  cibersort_per_samp_df_cols <- colnames(cibersort_per_samp_df)
  # print("cibersort_per_samp_df")
  cibersort_per_samp_df <- cbind(cibersort_per_samp_df,as.data.frame(matrix(unlist(lapply(seq(length(cibersort_per_samp_df$sample_ID)),function(ID_num){
                             ID <- cibersort_per_samp_df$sample_ID[ID_num]
                             barcode <- cibersort_per_samp_df$barcode[ID_num]
                             a<-which(combined_gene_metric_per_sample$sample_ID==ID)
                             if (length(a)==1){
                               return(as.character(combined_gene_metric_per_sample[a,cibersort_cols_to_add]))
                             } else if (length(a)>1){
                               aa<-which(combined_gene_metric_per_sample$barcode==barcode)
                               if (length(aa)==1){
                                 return(combined_gene_metric_per_sample[aa,cibersort_cols_to_add,drop=F])
                               } else if (length(aa)>1){
                                 dups<<-c(dups,ID)
                                 return(combined_gene_metric_per_sample[aa[1],cibersort_cols_to_add,drop=F])
                               } else {
                                 return(rep(NA,length(cibersort_cols_to_add)))
                               }
                             } else {
                               return(rep(NA,length(cibersort_cols_to_add)))
                             }
  })),byrow=T,nrow=nrow(cibersort_per_samp_df))))
  colnames(cibersort_per_samp_df) <- c(cibersort_per_samp_df_cols,cibersort_cols_to_add)
  cibersort_per_samp_df <- cibersort_per_samp_df[!(cibersort_per_samp_df$SampleID %in% dups),]
  
  a<-cor.test(combined_gene_metric_per_sample$splicing_antigenicity,log10(combined_gene_metric_per_sample$non_silent_mutations_per_mb+1),method="kendall")
  TMB_all_cor[cancer,"SA_vs_TMB_cor"]<-a$estimate
  TMB_all_pvals[cancer,"SA_vs_TMB_pval"]<-a$p.value
  

  a<-cor.test(combined_gene_metric_per_sample$splicing_antigenicity,combined_gene_metric_per_sample$leukocyte_fraction,method="kendall")
  TMB_all_cor[cancer,"SA_vs_leuk_frac_cor"]<-a$estimate
  TMB_all_pvals[cancer,"SA_vs_leuk_frac_pval"]<-a$p.value

  a<-cor.test(combined_gene_metric_per_sample$splicing_antigenicity,log10(combined_gene_metric_per_sample$numberOfImmunogenicMutation+1),method="kendall")
  TMB_all_cor[cancer,"SA_vs_numImmMut_cor"]<-a$estimate
  TMB_all_pvals[cancer,"SA_vs_numImmMut_pval"]<-a$p.value
  
  
  a<-cor.test(combined_gene_metric_per_sample$splicing_antigenicity,log2(combined_gene_metric_per_sample$num_TCR_Clones+1),method="kendall")
  TMB_all_cor[cancer,"SA_vs_num_TCR_Clones_cor"]<-a$estimate
  TMB_all_pvals[cancer,"SA_vs_num_TCR_Clones_pval"]<-a$p.value
  
  
  a<-cor.test(log10(combined_gene_metric_per_sample$numberOfImmunogenicMutation+1),log10(combined_gene_metric_per_sample$non_silent_mutations_per_mb+1),method="kendall")
  TMB_all_cor[cancer,"numImmMut_vs_TMB_cor"]<-a$estimate
  TMB_all_pvals[cancer,"numImmMut_vs_TMB_pval"]<-a$p.value
  
  
  for (cell in actual_cibersort_cells){
    a<-cor.test(as.numeric(cibersort_per_samp_df$splicing_antigenicity),as.numeric(cibersort_per_samp_df[,cell]),method="kendall")
    cibersort_all_cor[cancer,sprintf("%s",cell)]<-as.numeric(a$estimate)
    cibersort_all_pvals[cancer,sprintf("%s",cell)]<-as.numeric(a$p.value)
  }
  
  if (i == 1){
    cibersort_per_samp_df_all <- cibersort_per_samp_df
  } else {
    cibersort_per_samp_df_all <- rbind(cibersort_per_samp_df_all,cibersort_per_samp_df)
  }
  
    if (i == 1){
    combined_gene_metric_per_sample_all <- combined_gene_metric_per_sample
  } else {
    combined_gene_metric_per_sample_all <- rbind(combined_gene_metric_per_sample_all,combined_gene_metric_per_sample)
  }
  print("-------------------------------------------------------")
}
saveRDS(combined_gene_metric_per_sample_all,file=mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_SA_per_sample.rds"))
write.csv(combined_gene_metric_per_sample_all,file=mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_SA_per_sample.csv"))
saveRDS(TMB_all_cor,file=mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/SA_correlations.rds"))
saveRDS(TMB_all_pvals,file=mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/SA_pvals.rds"))
saveRDS(cibersort_all_cor,file=mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/cibersort_SA_correlations.rds"))
saveRDS(cibersort_all_pvals,file=mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/cibersort_SA_pvals.rds"))
saveRDS(combined_gene_metric_tumor_all_samples,mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_gene_metric_tumor_all_samples.rds"))
write.csv(combined_gene_metric_tumor_all_samples,
          mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_gene_metric_tumor_all_samples.csv"))
saveRDS(combined_gene_metric_normal_all_samples,
        mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_gene_metric_normal_all_samples.rds"))
write.csv(combined_gene_metric_normal_all_samples,
        mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_gene_metric_normal_all_samples.csv"))
saveRDS(combined_gene_metric_tumor_all_genes,mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_gene_metric_tumor_all_genes.rds"))
write.csv(combined_gene_metric_tumor_all_genes,mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_gene_metric_tumor_all_genes.csv"))
saveRDS(combined_gene_metric_normal_all_genes,mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_gene_metric_normal_all_genes.rds"))
write.csv(combined_gene_metric_normal_all_genes,mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_gene_metric_normal_all_genes.csv"))
saveRDS(combined_gene_metric_DA_all,file=mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_gene_metric_DA_all.rds"))
write.csv(combined_gene_metric_DA_all,file=mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_gene_metric_DA_all.txt"))

```

```{r,eval=T}

combined_gene_metric_per_sample_all <- readRDS(mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_SA_per_sample.rds"))
TMB_all_cor <- readRDS(mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/SA_correlations.rds"))
TMB_all_pvals <- readRDS(mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/SA_pvals.rds"))
cibersort_all_cor <- readRDS(mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/cibersort_SA_correlations.rds"))
cibersort_all_pvals <- readRDS(mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/cibersort_SA_pvals.rds"))
combined_gene_metric_tumor_all_samples <- readRDS(mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_gene_metric_tumor_all_samples.rds"))
combined_gene_metric_tumor_all_genes <- readRDS(mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_gene_metric_tumor_all_genes.rds"))
combined_gene_metric_normal_all_samples <- readRDS(mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_gene_metric_normal_all_samples.rds"))
combined_gene_metric_normal_all_genes <- readRDS(mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_gene_metric_normal_all_genes.rds"))
combined_gene_metric_DA_all <- readRDS(mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/combined_gene_metric_DA_all.rds"))

```


## Plotting splicing antigenicity give TMB split

```{r}

cancers <- unique(combined_gene_metric_per_sample_all$cancer)
comb_gene_metric_fold_change_cor <- data.frame(cancer=cancers)
rownames(comb_gene_metric_fold_change_cor)<-cancers
comb_gene_metric_pvals <- data.frame(cancer=cancers)
rownames(comb_gene_metric_pvals) <- cancers
counts <- data.frame(cancer=cancers)
row.names(counts) <- cancers

for (cancer in cancers){
  print(cancer)
  # performing TMB type eval
  rows_filt<-!is.na(combined_gene_metric_per_sample_all$non_silent_mutations_per_mb) & combined_gene_metric_per_sample_all$cancer==cancer
  combined_gene_metric_per_sample_filt <- combined_gene_metric_per_sample_all[rows_filt,]
  combined_gene_metric_per_sample_filt$TMB_TYPE <- factor(combined_gene_metric_per_sample_filt$TMB_TYPE,levels=c("TMB LOW","TMB HIGH"))
  HIGH_COUNT=length(which(combined_gene_metric_per_sample_filt$TMB_TYPE=="TMB HIGH"))
  LOW_COUNT=length(which(combined_gene_metric_per_sample_filt$TMB_TYPE=="TMB LOW"))
  counts[cancer,"HIGH_COUNT"] <- HIGH_COUNT
  counts[cancer,"LOW_COUNT"] <- LOW_COUNT
  
  if (HIGH_COUNT > 0 & LOW_COUNT > 0){
    
    wilcox_test_val <- compare_means(splicing_antigenicity ~ TMB_TYPE, p.adjust.method = "BH", 
                             data=combined_gene_metric_per_sample_filt)
    TMB_HIGH_VAL <- mean(combined_gene_metric_per_sample_filt[combined_gene_metric_per_sample_filt$TMB_TYPE=="TMB HIGH","splicing_antigenicity"],na.rm=T)
    TMB_LOW_VAL <- mean(combined_gene_metric_per_sample_filt[combined_gene_metric_per_sample_filt$TMB_TYPE=="TMB LOW","splicing_antigenicity"],na.rm=T)
    comb_gene_metric_fold_change_cor[cancer,"log2_TMB_HIGH_ov_TMB_LOW"] <- log2(TMB_HIGH_VAL/TMB_LOW_VAL)
    comb_gene_metric_pvals[cancer,"BH_pval_wilcoxon"]<-wilcox_test_val$p.adj
  } else {
      comb_gene_metric_fold_change_cor[cancer,"log2_TMB_HIGH_ov_TMB_LOW"] <- 1
      comb_gene_metric_pvals[cancer,"BH_pval_wilcoxon"]<-1
  }
}

comb_gene_metric <- data.frame(cancer=cancers,
                               log2_TMB_HIGH_ov_TMB_LOW=comb_gene_metric_fold_change_cor$log2_TMB_HIGH_ov_TMB_LOW,
                               BH_pval_wilcoxon=comb_gene_metric_pvals$BH_pval_wilcoxon)

cancer_HIGH_ov_LOW <- sprintf("%s:%d/%d",comb_gene_metric$cancer,counts[comb_gene_metric$cancer,"HIGH_COUNT"],counts[comb_gene_metric$cancer,"LOW_COUNT"])
ggplot(comb_gene_metric,aes(x=log2_TMB_HIGH_ov_TMB_LOW,y=-log10(BH_pval_wilcoxon),
                            label=cancer,color=cancer_HIGH_ov_LOW))+
  geom_hline(yintercept=-log10(0.05))+
  geom_point()+
  geom_text_repel()+
  xlab("log2(mean HIGH TMB sample SA / mean LOW TMB sample SA)")+
  ylab("-log10(wilcoxon BH adjusted pval)")+
  labs(color='cancer:(TMB High)/(TMB LOW)')

```

## Plotting splicing antigenicity vs all other metrics kendall correlation 

```{r}

# splitting TMB_all 
TMB_all_cor_filt <- t(TMB_all_cor[,seq(2,ncol(TMB_all_cor)-1)])
TMB_all_pvals_filt <- t(TMB_all_pvals[,seq(2,ncol(TMB_all_pvals)-1)])

rownames(TMB_all_cor_filt) <- c("SA vs TMB","SA vs Leukocyte Fraction", "SA vs Num. Imm. Mut.", "SA vs Num. TCR Clones")
  
Heatmap(as.matrix(TMB_all_cor_filt), cell_fun = function(j, i, x, y, w, h, fill) {
  if (is.na(TMB_all_pvals_filt[i,j])){
    grid.text(".",x,y)
  }else if(TMB_all_pvals_filt[i, j] < 0.005 & abs(TMB_all_cor_filt[i, j]) >= 0.2) {
      grid.text("**", x, y)
  } else if(TMB_all_pvals_filt[i, j] < 0.05 & abs(TMB_all_cor_filt[i, j]) >= 0.2) {
      grid.text("*", x, y)
  }
},cluster_columns=T,name="kendall cor",
clustering_method_rows="ward.D2",
clustering_method_columns="ward.D2")

TMB_all_cor_filt <- t(TMB_all_cor[,seq(2,ncol(TMB_all_cor))])
TMB_all_pvals_filt <- t(TMB_all_pvals[,seq(2,ncol(TMB_all_pvals))])
TMB_all <- cbind(TMB_all_cor,TMB_all_pvals[,seq(2,ncol(TMB_all_pvals))])
TMB_all_cor_cols<-colnames(TMB_all_cor)
TMB_all_pval_cols <- str_replace(TMB_all_cor_cols,"cor","pval")
for (i in seq(nrow(TMB_all_cor_filt))){
  print(ggplot(TMB_all,aes(x=TMB_all[,i+1],y=-log10(TMB_all[,i+1+5]),label=cancers,color=cancers))+
          geom_hline(yintercept=-log10(0.05))+
          geom_text_repel()+
          geom_point()+
          xlab(TMB_all_cor_cols[i+1])+
          ylab(TMB_all_pval_cols[i+1])+
          theme(legend.position="none"))
}

ggplot(combined_gene_metric_tumor_all_samples,aes(y=SA,x=cancer))+
  geom_boxplot()+geom_violin(alpha=0.2,fill="grey")

write.csv(TMB_all,file=mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/TheImmuneLandscapeOfCancer_SA_correlations.csv"))

```

## Evaluating the relationship to metrics of response to immunotherapy per cancer subtype for high-splicing antigenicity samples vs low splicing antigenicity samples

```{r}



```


## Processing CIBERSORT Data

```{r}

cibersort_all_cor_filt<-t(cibersort_all_cor[,seq(2,ncol(cibersort_all_cor))])
cibersort_all_cor_filt[is.na(cibersort_all_cor_filt)]<-0
cibersort_all_pvals_filt<-t(cibersort_all_pvals[,seq(2,ncol(cibersort_all_pvals))])
cibersort_all_pvals_filt[is.na(cibersort_all_pvals_filt)]<-1

print(Heatmap(as.matrix(cibersort_all_cor_filt), cell_fun = function(j, i, x, y, w, h, fill) {
  if (is.na(cibersort_all_pvals_filt[i,j])){
    grid.text(".",x,y)
  }else if(cibersort_all_pvals_filt[i, j] < 0.005 & abs(cibersort_all_cor_filt[i, j]) >= 0.2) {
      grid.text("**", x, y)
  } else if(cibersort_all_pvals_filt[i, j] < 0.05 & abs(cibersort_all_cor_filt[i, j]) >= 0.2) {
      grid.text("*", x, y)
  }
},cluster_columns=T,name="kendall cor",
clustering_method_rows="ward.D2",
clustering_method_columns="ward.D2"))

cibersort_correlations_pvalues <- data.frame(TCGA_subtype=NA,immune_cell_type=NA,tau=NA,pvalue=NA)
supplement_forming_meta <- vapply(unique(cibersort_all_cor$cancers),function(cancer){
  immune_cell_type <- as.character(unname(colnames(cibersort_all_cor)[seq(2,ncol(cibersort_all_cor))]))
  tau <- as.character(unname(cibersort_all_cor[cibersort_all_cor$cancers==cancer,][seq(2,ncol(cibersort_all_cor))]))
  pvalue <- as.character(unname(cibersort_all_pvals[cibersort_all_pvals$cancers==cancer,][seq(2,ncol(cibersort_all_pvals))]))
  cibersort_filler <- data.frame(TCGA_subtype=rep(cancer,length(tau)),immune_cell_type=immune_cell_type,tau=tau,pvalue=pvalue)
  cibersort_correlations_pvalues <<- rbind(cibersort_correlations_pvalues,cibersort_filler)
  return(T)
},logical(1))
cibersort_correlations_pvalues <- cibersort_correlations_pvalues[seq(2,nrow(cibersort_correlations_pvalues)),]

cibersort_all_cor_filt <- data.frame(cibersort_all_cor_filt)
cell_type_order <- c("T.cells.CD8","Dendritic.cells.resting","Macrophages.M1","T.cells.CD4.memory.resting","B.cells.memory","T.cells.regulatory..Tregs.",
                     "T.cells.follicular.helper","Macrophages.M0","T.cells.CD4.memory.activated","Monocytes","B.cells.naive","Mast.cells.resting","NK.cells.activated","Dendritic.cells.activated","Neutrophils","Eosinophils","Mast.cells.activated","Plasma.cells","T.cells.CD4.naive","Macrophages.M2","NK.cells.resting","T.cells.gamma.delta")
CHOL_LIHC <- data.frame(CHOL=cibersort_all_cor_filt[,"CHOL"],LIHC=cibersort_all_cor_filt[,"LIHC"],cell_type=rownames(cibersort_all_cor_filt))
CHOL_LIHC$LIHC_ov_CHOL <- CHOL_LIHC$LIHC/CHOL_LIHC$CHOL
CHOL_LIHC <- CHOL_LIHC[order(CHOL_LIHC$LIHC_ov_CHOL),]
CHOL_LIHC$cell_type <- factor(CHOL_LIHC$cell_type,levels=rev(cell_type_order))

ggplot(CHOL_LIHC,aes(y=cell_type,x=LIHC_ov_CHOL,fill=sign(LIHC)))+
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(angle = 90))+
  geom_vline(xintercept=1)+
  geom_vline(xintercept=-1)+
  xlab("LIHC tau/CHOL tau")

print(mean(CHOL_LIHC[CHOL_LIHC$cell_type %in% c("T.cells.CD8","Dendritic.cells.resting","Macrophages.M1","T.cells.CD4.memory.resting","B.cells.memory","T.cells.regulatory..Tregs.",
                     "T.cells.follicular.helper"),"LIHC_ov_CHOL"]))

write.csv(cibersort_correlations_pvalues,file=mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/TheImmuneLandscapeOfCancer_SA_CIBERSORT_correlations.csv"))

```

### Looking at correlation between splicing antigenicity for cholangiocarcinoma (CHOL) and liver hepatocellular carcinoma (LIHC)

```{r}



```


## TMB Correlation for all samples

```{r}

HIGH_COUNT=length(which(combined_gene_metric_per_sample_all$TMB_TYPE=="TMB HIGH"))
LOW_COUNT=length(which(combined_gene_metric_per_sample_all$TMB_TYPE=="TMB LOW"))
my_comparisons <- list( c("TMB LOW", "TMB HIGH"))
wilcox_test_val <- compare_means(splicing_antigenicity ~ TMB_TYPE, 
                             comparisons = my_comparisons, p.adjust.method = "BH", data=combined_gene_metric_per_sample_all)
combined_gene_metric_per_sample_all_filt <- combined_gene_metric_per_sample_all[!is.na(combined_gene_metric_per_sample_all$non_silent_mutations_per_mb),]
print(ggplot(combined_gene_metric_per_sample_all_filt,aes(y=splicing_antigenicity,x=TMB_TYPE))+
  geom_boxplot(fill="grey")+stat_pvalue_manual(wilcox_test_val, 
  y.position = max(combined_gene_metric_per_sample_all_filt$splicing_antigenicity)+(max(combined_gene_metric_per_sample_all_filt$splicing_antigenicity)/2),
  label = "p.adj" )+labs(title=sprintf("all cohorts, HIGH: %d, LOW: %d",HIGH_COUNT,LOW_COUNT))+
    ylab(("splicing antigenicity")))

ggplot(combined_gene_metric_per_sample_all_filt,aes(x=splicing_antigenicity,y=log10(non_silent_mutations_per_mb+1)))+
  geom_point()+
  stat_cor(method = "kendall",label.x.npc="middle",label.y.npc="top")+
  geom_smooth(method="lm")+
    labs("All Samples")+
  ylab("log10(TMB)")

combined_gene_metric_per_sample_all_sum <- data.frame(cancer=unique(combined_gene_metric_per_sample_all_filt$cancer))
rownames(combined_gene_metric_per_sample_all_sum) <- combined_gene_metric_per_sample_all_sum$cancer
for (cancer in combined_gene_metric_per_sample_all$cancer){
  combined_gene_metric_per_sample_small <- combined_gene_metric_per_sample_all_filt[combined_gene_metric_per_sample_all_filt$cancer==cancer,]
  combined_gene_metric_per_sample_all_sum[combined_gene_metric_per_sample_all_sum$cancer==cancer,"median_TMB"] <- median(combined_gene_metric_per_sample_small$non_silent_mutations_per_mb,na.rm=T)
  combined_gene_metric_per_sample_all_sum[combined_gene_metric_per_sample_all_sum$cancer==cancer,"splicing_antigenicity"] <- mean(combined_gene_metric_per_sample_small$splicing_antigenicity,na.rm=T)
}
ggplot(combined_gene_metric_per_sample_all_sum,aes(x=splicing_antigenicity,y=median_TMB,label=cancer))+
  stat_cor(method = "kendall",label.x.npc="middle",label.y.npc="top")+
  geom_smooth(method="lm")+
  geom_text_repel()+
  labs("All Samples")+
  xlab("splicing antigenicity")+ylab("median TMB")+
  theme(legend.position="none")

ggplot(combined_gene_metric_DA_all,aes(x=cancer,y=log2(DA)))+
  geom_boxplot()+
  geom_hline(yintercept=0)+
  ylab("Differential Agretopicity")+
  xlab("Cancer Subtype")+
  theme(axis.text.x = element_text(angle = 90))

ggplot(combined_gene_metric_DA_all,aes(x=cancer,y=log2(DA)))+
  geom_boxplot()+geom_violin(alpha=0.2,fill="grey")+
  geom_hline(yintercept=0)+
  ylab("Differential Agretopicity")+
  xlab("Cancer Subtype")+
  theme(axis.text.x = element_text(angle = 90))

```

# Tumor vs normal SA averaged across samples

```{r}

combined_gene_metric_tumor_all_genes$type <- "tumor"
combined_gene_metric_normal_all_genes$type <- "normal"
combined_gene_metric_tumor_normal_all_genes <- rbind(combined_gene_metric_tumor_all_genes,
                                               combined_gene_metric_normal_all_genes)
wilcox_test_val <- compare_means(SA ~ type, p.adjust.method = "BH", data=combined_gene_metric_tumor_normal_all_genes,group.by = c("cancer"))
tumor_over_normal_FC <- vapply(cancers,function(cancer){
  tumor_mean <- mean(combined_gene_metric_tumor_normal_all_genes$SA[combined_gene_metric_tumor_normal_all_genes$cancer==cancer & combined_gene_metric_tumor_normal_all_genes$type=="tumor"],na.rm=T)
  normal_mean <- mean(combined_gene_metric_tumor_normal_all_genes$SA[combined_gene_metric_tumor_normal_all_genes$cancer==cancer & combined_gene_metric_tumor_normal_all_genes$type=="normal"],na.rm=T)
  return(tumor_mean/normal_mean)
},numeric(1))

tumor_minus_normal_EZ <- vapply(cancers,function(cancer){
  tumor_mean <- mean(combined_gene_metric_tumor_normal_all_genes$SA[combined_gene_metric_tumor_normal_all_genes$cancer==cancer & combined_gene_metric_tumor_normal_all_genes$type=="tumor"],na.rm=T)
  normal_mean <- mean(combined_gene_metric_tumor_normal_all_genes$SA[combined_gene_metric_tumor_normal_all_genes$cancer==cancer & combined_gene_metric_tumor_normal_all_genes$type=="normal"],na.rm=T)
  tumor_sd <- sd(combined_gene_metric_tumor_normal_all_genes$SA[combined_gene_metric_tumor_normal_all_genes$cancer==cancer & combined_gene_metric_tumor_normal_all_genes$type=="tumor"],na.rm=T)
  return((tumor_mean-normal_mean) / tumor_sd)
},numeric(1))

pval_FC <- data.frame(cancer=wilcox_test_val$cancer)
rownames(pval_FC) <- pval_FC$cancer
pval_FC[names(tumor_over_normal_FC),"tumor_ov_normal"] <- tumor_over_normal_FC
pval_FC[wilcox_test_val$cancer,"pval_BH"] <- wilcox_test_val$p.adj
pval_FC[names(tumor_minus_normal_EZ),"tumor_minus_normal_EZ"] <- tumor_minus_normal_EZ

pval_FC$significance<-vapply(pval_FC$pval_BH<=0.05,function(value){
  if (value){return("Sig")}else{return("Insig")}
},character(1))
ggplot(pval_FC,
       aes(x=log2(tumor_ov_normal),y=-log10(pval_BH),label=cancer,color=cancer))+
  geom_hline(yintercept=-log10(0.05))+
  geom_point()+
  geom_text_repel()+
  theme(legend.position="none")+
  xlab("log2(tumor SA / normal SA)")+
  ylab("-log10(wilcoxon BH adjusted pval)")

ggplot(pval_FC,
       aes(x=tumor_minus_normal_EZ,y=-log10(pval_BH),label=cancer,color=cancer))+
  geom_hline(yintercept=-log10(0.05))+
  geom_point()+
  geom_text_repel()+
  theme(legend.position="none")+
  xlab("log2(tumor SA / normal SA)")+
  ylab("-log10(wilcoxon BH adjusted pval)")

ggplot(combined_gene_metric_tumor_normal_all_genes,aes(x=type,y=SA))+
  geom_boxplot()+
  facet_grid(~cancer)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  add_pvalue(wilcox_test_val,label = "p.signif", remove.bracket = TRUE,y.position=max(combined_gene_metric_tumor_normal_all_genes$SA)+0.01)

ggplot(pval_FC,aes(x=cancer,y=tumor_minus_normal_EZ))+
  geom_bar(stat="identity")+
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ylab("Effect Size")


```

# Tumor vs normal SA averaged across genes

```{r}

combined_gene_metric_tumor_normal_all_samples <- rbind(combined_gene_metric_tumor_all_samples,
                                               combined_gene_metric_normal_all_samples)
wilcox_test_val <- compare_means(SA ~ type, p.adjust.method = "BH", data=combined_gene_metric_tumor_normal_all_samples,group.by = c("cancer"))
tumor_over_normal_FC <- vapply(cancers,function(cancer){
  tumor_mean <- mean(combined_gene_metric_tumor_normal_all_samples$SA[combined_gene_metric_tumor_normal_all_samples$cancer==cancer & combined_gene_metric_tumor_normal_all_samples$type=="tumor"],na.rm=T)
  normal_mean <- mean(combined_gene_metric_tumor_normal_all_samples$SA[combined_gene_metric_tumor_normal_all_samples$cancer==cancer & combined_gene_metric_tumor_normal_all_samples$type=="normal"],na.rm=T)
  return(tumor_mean/normal_mean)
},numeric(1))

tumor_minus_normal_EZ <- vapply(cancers,function(cancer){
  tumor_mean <- mean(combined_gene_metric_tumor_normal_all_samples$SA[combined_gene_metric_tumor_normal_all_samples$cancer==cancer & combined_gene_metric_tumor_normal_all_samples$type=="tumor"],na.rm=T)
  normal_mean <- mean(combined_gene_metric_tumor_normal_all_samples$SA[combined_gene_metric_tumor_normal_all_samples$cancer==cancer & combined_gene_metric_tumor_normal_all_samples$type=="normal"],na.rm=T)
  tumor_sd <- sd(combined_gene_metric_tumor_normal_all_samples$SA[combined_gene_metric_tumor_normal_all_samples$cancer==cancer & combined_gene_metric_tumor_normal_all_samples$type=="tumor"],na.rm=T)
  return((tumor_mean-normal_mean) / tumor_sd)
},numeric(1))

pval_FC <- data.frame(cancer=wilcox_test_val$cancer)
rownames(pval_FC) <- pval_FC$cancer
pval_FC[names(tumor_over_normal_FC),"tumor_ov_normal"] <- tumor_over_normal_FC
pval_FC[wilcox_test_val$cancer,"pval_BH"] <- wilcox_test_val$p.adj
pval_FC[names(tumor_minus_normal_EZ),"tumor_minus_normal_EZ"] <- tumor_minus_normal_EZ

pval_FC$significance<-vapply(pval_FC$pval_BH<=0.05,function(value){
  if (value){return("Sig")}else{return("Insig")}
},character(1))
ggplot(pval_FC,
       aes(x=log2(tumor_ov_normal),y=-log10(pval_BH),label=cancer,color=cancer))+
  geom_hline(yintercept=-log10(0.05))+
  geom_point()+
  geom_text_repel()+
  theme(legend.position="none")+
  xlab("log2(tumor SA / normal SA)")+
  ylab("-log10(wilcoxon BH adjusted pval)")

ggplot(combined_gene_metric_tumor_normal_all_genes,aes(x=type,y=SA))+
  geom_boxplot()+
  facet_grid(~cancer)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  add_pvalue(wilcox_test_val,label = "p.signif", remove.bracket = TRUE,y.position=max(combined_gene_metric_tumor_normal_all_genes$SA)+0.01)

ggplot(pval_FC,aes(x=cancer,y=tumor_minus_normal_EZ))+
  geom_bar(stat="identity")+
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ylab("Effect Size")

```


## TMB, splicing antigenicity, and junction types per cancer

```{r}

tumor_data_file <- mod_path("/mnt/f/TCGA_junctions/TCGA_cancers/JHPCE/cancer_dirs_filt.txt")
tumor_data <- read.table(tumor_data_file)
cancers <- tumor_data$V1
TCGA_ROOT_DIR=mod_path("/mnt/f/TCGA_junctions/TCGA_cancers")
intron_counts_per_cancer <- data.frame(cancers)
rownames(intron_counts_per_cancer)<-intron_counts_per_cancer$cancers
intron_types <- c("annotated","cryptic_fiveprime","cryptic_threeprime","cryptic_unanchored","novel annotated pair")
intron_counts_per_cancer[,intron_types]<-0
intron_counts_per_cancer <- intron_counts_per_cancer[,seq(2,ncol(intron_counts_per_cancer))]

for (cancer in cancers){
  print(cancer)
  cancer_leafcutter_file <- sprintf("%s/%s/JHPCE/leafcutter_out/data.Rdata",TCGA_ROOT_DIR,cancer)
  load(cancer_leafcutter_file)
  introns_tumor <- introns[introns$deltapsi>0,]
  intron_counts_per_cancer[cancer,]<-vapply(intron_types,function(intron_type){
    return(length(which(introns_tumor$verdict==intron_type)))
  },numeric(1))
}

intron_counts_per_cancer_norm <- intron_counts_per_cancer/apply(intron_counts_per_cancer,1,sum)
intron_counts_per_cancer_scaled <- data.frame(apply(intron_counts_per_cancer_norm,2,scale))
rownames(intron_counts_per_cancer_scaled)<-rownames(intron_counts_per_cancer_norm)
colnames(intron_counts_per_cancer_scaled) <- intron_types

print(Heatmap(t(intron_counts_per_cancer_scaled),
        top_annotation = HeatmapAnnotation(median_TMB=anno_barplot(combined_gene_metric_per_sample_all_sum[rownames(intron_counts_per_cancer),"median_TMB"])),
        bottom_annotation = HeatmapAnnotation(splicing_antigenicity=anno_barplot(combined_gene_metric_per_sample_all_sum[rownames(intron_counts_per_cancer),"splicing_antigenicity"])),
        show_row_names=T,
        show_column_names = T,
        cluster_rows=T,
        cluster_columns=T,
        heatmap_legend_param=list(title="zscore"),
clustering_method_rows="ward.D2",
clustering_method_columns="ward.D2"))

print(Heatmap(t(log10(intron_counts_per_cancer)),
        top_annotation = HeatmapAnnotation(median_TMB=anno_barplot(combined_gene_metric_per_sample_all_sum[rownames(intron_counts_per_cancer),"median_TMB"])),
        show_row_names=T,
        show_column_names = T,
        cluster_rows=T,
        cluster_columns=T,
        heatmap_legend_param=list(title="log10(counts)"),
clustering_method_rows="ward.D2",
clustering_method_columns="ward.D2"))

```


# Analyzing Splicing Factor Mutations per cancer type including missense mutations

```{r,eval=F}

# Reading in supplementary data

TCGA_mutation_representation <- read_excel(mod_path("/mnt/f/splicing_factor_paper/NIHMS958968-supplement-3.xlsx"),skip=2)
TCGA_mutation_representation$sample_ID <- vapply(TCGAbarcode(TCGA_mutation_representation$Tumor_Sample_Barcode,sample=T),
                                       function(val){substr(val,1,nchar(val)-1)},character(1))
TCGA_mutation_representation_filt <- TCGA_mutation_representation[TCGA_mutation_representation$sample_ID %in% combined_gene_metric_per_sample_all$sample_ID,]
cancers <- unique(TCGA_mutation_representation_filt$Cohort)
splicing_factor_genes <- unique(TCGA_mutation_representation_filt$Hugo_Symbol)
for (gene in splicing_factor_genes){
  combined_gene_metric_per_sample_all[,gene]<-"WT"
  TCGA_mutation_representation_filt_small <- TCGA_mutation_representation_filt[TCGA_mutation_representation_filt$Hugo_Symbol==gene,]
  combined_gene_metric_per_sample_all[combined_gene_metric_per_sample_all$sample %in% TCGA_mutation_representation_filt_small$sample_ID,gene]<-"MUT"
}

for (cancer in cancers){
    combined_gene_metric_per_sample_all_small <- combined_gene_metric_per_sample_all[combined_gene_metric_per_sample_all$cancer==cancer,]
    my_comparisons=list(c("WT","MUT"))
    
    MUT_VALS<-length(which(combined_gene_metric_per_sample_all_small$SF3B1=="MUT"))
    WT_VALS<-length(which(combined_gene_metric_per_sample_all_small$SF3B1=="WT"))
    if (MUT_VALS>0 & WT_VALS>0){
      wixoc_test_val <- compare_means(splicing_antigenicity ~ SF3B1,comparisons = my_comparisons, p.adjust.method = "BH", data=combined_gene_metric_per_sample_all_small)
      print(ggplot(combined_gene_metric_per_sample_all_small,aes(y=splicing_antigenicity,x=SF3B1))+
      geom_boxplot(fill="grey")+
        stat_pvalue_manual(wixoc_test_val, 
    y.position = max(combined_gene_metric_per_sample_all_small$splicing_antigenicity)+(max(combined_gene_metric_per_sample_all_small$splicing_antigenicity)/2),
    label = "p.adj" )+
      labs(title=sprintf("%s: MUT=%d,WT=%d",cancer,MUT_VALS,WT_VALS))+
        ylab("splicing antigenicity"))
    } else {
      print(ggplot(combined_gene_metric_per_sample_all_small,aes(y=splicing_antigenicity,x=SF3B1))+
      geom_boxplot(fill="grey")+
      labs(title=sprintf("%s: MUT=%d,WT=%d",cancer,MUT_VALS,WT_VALS))+
        ylab("splicing antigenicity"))
    }

    MUT_VALS<-length(which(combined_gene_metric_per_sample_all_small$U2AF1=="MUT"))
    WT_VALS<-length(which(combined_gene_metric_per_sample_all_small$U2AF1=="WT"))
    if (MUT_VALS>0 & WT_VALS>0){
      wixoc_test_val <- compare_means(splicing_antigenicity ~ U2AF1,comparisons = my_comparisons, p.adjust.method = "BH", data=combined_gene_metric_per_sample_all_small)
      print(ggplot(combined_gene_metric_per_sample_all_small,aes(y=splicing_antigenicity,x=U2AF1))+
      geom_boxplot(fill="grey")+
        stat_pvalue_manual(wixoc_test_val, 
    y.position = max(combined_gene_metric_per_sample_all_small$splicing_antigenicity)+(max(combined_gene_metric_per_sample_all_small$splicing_antigenicity)/2),
    label = "p.adj" )+
      labs(title=sprintf("%s: MUT=%d,WT=%d",cancer,MUT_VALS,WT_VALS))+
        ylab("splicing antigenicity"))
    } else {
      print(ggplot(combined_gene_metric_per_sample_all_small,aes(y=splicing_antigenicity,x=U2AF1))+
      geom_boxplot(fill="grey")+
      labs(title=sprintf("%s: MUT=%d,WT=%d",cancer,MUT_VALS,WT_VALS))+
        ylab("splicing antigenicity"))
    }

        
    MUT_VALS<-length(which(combined_gene_metric_per_sample_all_small$SRSF2=="MUT"))
    WT_VALS<-length(which(combined_gene_metric_per_sample_all_small$SRSF2=="WT"))
    if (MUT_VALS>0 & WT_VALS>0){
      wixoc_test_val <- compare_means(splicing_antigenicity ~ SRSF2,comparisons = my_comparisons, p.adjust.method = "BH", data=combined_gene_metric_per_sample_all_small)
      print(ggplot(combined_gene_metric_per_sample_all_small,aes(y=splicing_antigenicity,x=SRSF2))+
        geom_boxplot(fill="grey")+
        stat_pvalue_manual(wixoc_test_val, 
    y.position = max(combined_gene_metric_per_sample_all_small$splicing_antigenicity)+(max(combined_gene_metric_per_sample_all_small$splicing_antigenicity)/2),
    label = "p.adj" )+
      labs(title=sprintf("%s: MUT=%d,WT=%d",cancer,MUT_VALS,WT_VALS))+
        ylab("splicing antigenicity"))
    } else {
      print(ggplot(combined_gene_metric_per_sample_all_small,aes(y=splicing_antigenicity,x=SRSF2))+
      geom_boxplot(fill="grey")+
      labs(title=sprintf("%s: MUT=%d,WT=%d",cancer,MUT_VALS,WT_VALS))+
        ylab("splicing antigenicity"))
    }
    
    MUT_VALS<-length(which(combined_gene_metric_per_sample_all_small$RBM10=="MUT"))
    WT_VALS<-length(which(combined_gene_metric_per_sample_all_small$RBM10=="WT"))
    if (MUT_VALS>0 & WT_VALS>0){
      wixoc_test_val <- compare_means(splicing_antigenicity ~ RBM10,comparisons = my_comparisons, p.adjust.method = "BH", data=combined_gene_metric_per_sample_all_small)
      print(ggplot(combined_gene_metric_per_sample_all_small,aes(y=splicing_antigenicity,x=RBM10))+
      geom_boxplot(fill="grey")+
        stat_pvalue_manual(wixoc_test_val,
    y.position = max(combined_gene_metric_per_sample_all_small$splicing_antigenicity)+(max(combined_gene_metric_per_sample_all_small$splicing_antigenicity)/2),
    label = "p.adj" )+
      labs(title=sprintf("%s: MUT=%d,WT=%d",cancer,MUT_VALS,WT_VALS))+
        ylab("splicing antigenicity"))
    } else {
      print(ggplot(combined_gene_metric_per_sample_all_small,aes(y=splicing_antigenicity,x=RBM10))+
      geom_boxplot(fill="grey")+
      labs(title=sprintf("%s: MUT=%d,WT=%d",cancer,MUT_VALS,WT_VALS))+
        ylab("splicing antigenicity"))
    }
    
}

```

## Evaluating the 119 splicing factor genes in the splicing paper manner

```{r,eval=F}

splicing_factor_genes<-read_excel(mod_path("/mnt/f/TCGA_junctions/ext_dat/splicing_factor_genes1.xlsx"))
splice_maf_file <- read.table(mod_path("/mnt/f/TCGA_junctions/TCGA_cancers/JHPCE/filter_maf/output/filenames.txt"),header=F)

for (i in seq(nrow(splice_maf_file))){
  file<-mod_path(splice_maf_file[i,1])
  gene <- unlist(strsplit(basename(file),"_"))[1]
  gene_maf_dat <- read.table(file,header=T,sep="\t",quote="")
  gene_maf_dat_filt<-gene_maf_dat[gene_maf_dat$Hugo_Symbol==gene,]
  if (i==1){
    splice_maf_data <- gene_maf_dat_filt
  } else {
    splice_maf_data <- rbind(splice_maf_data,gene_maf_dat_filt)
  }
}

saveRDS(splice_maf_data,file=mod_path("/mnt/f/TCGA_junctions/TCGA_cancers/JHPCE/filter_maf/output/splicing_factor_data.maf.rds"))
write.table(splice_maf_data,file=mod_path("/mnt/f/TCGA_junctions/TCGA_cancers/JHPCE/filter_maf/output/splicing_factor_data.maf"),col.names=T,sep="\t",quote=F)

```

```{r}

# this is where I need to plot splicing antigenicity across mutant and wild-type otherwise my data does not match correctly for 119 vs individual

splice_vals <- data.frame(cancer=cancers)
rownames(splice_vals) <- cancers

# Ben Ho Park genes: SF3B1, U2AF1 or SRSF2
splice_maf_data <- readRDS(mod_path("/mnt/f/TCGA_junctions/TCGA_cancers/JHPCE/filter_maf/output/splicing_factor_data.maf.rds"))
splice_maf_data$sample_ID <- vapply(TCGAbarcode(splice_maf_data$Tumor_Sample_Barcode,sample=T),
                                       function(val){substr(val,1,nchar(val)-1)},character(1))
splice_maf_data_filt <- splice_maf_data[splice_maf_data$sample_ID %in% combined_gene_metric_per_sample_all$sample,]
splicing_factor_genes <- c(unique(splice_maf_data$Hugo_Symbol),"RBM39")
cancers <- unique(combined_gene_metric_per_sample_all$cancer)
for (gene in splicing_factor_genes){
  combined_gene_metric_per_sample_all[,gene]<-"WT"
  splice_maf_data_filt_small <- splice_maf_data_filt[splice_maf_data_filt$Hugo_Symbol==gene,]
  combined_gene_metric_per_sample_all[combined_gene_metric_per_sample_all$sample %in% splice_maf_data_filt_small$sample_ID,gene]<-"MUT"
}
combined_gene_metric_per_sample_all[,"all_genes"]<-"WT"
combined_gene_metric_per_sample_all[combined_gene_metric_per_sample_all$sample %in% splice_maf_data_filt$sample_ID,"all_genes"]<-"MUT"
wilcox_test_val_all <- compare_means(splicing_antigenicity ~ all_genes,comparisons = my_comparisons, p.adjust.method = "BH", data=combined_gene_metric_per_sample_all,group.by = "cancer")

all_comps_df <- data.frame(cancer=cancers)
rownames(all_comps_df) <- cancers


for (i in seq(length(cancers))){
  print(i)
  cancer <- cancers[i]
  combined_gene_metric_per_sample_all_small <- combined_gene_metric_per_sample_all[combined_gene_metric_per_sample_all$cancer==cancer,]
  my_comparisons=list(c("WT","MUT"))
  MUT_VALS<-length(which(combined_gene_metric_per_sample_all_small$all_genes=="MUT"))
  WT_VALS<-length(which(combined_gene_metric_per_sample_all_small$all_genes=="WT"))
  if (MUT_VALS>0 & WT_VALS>0){
    graph_plot_SF_genes(combined_gene_metric_per_sample_all_small)
    wilcox_test_val <- compare_means(splicing_antigenicity ~ all_genes,comparisons = my_comparisons, p.adjust.method = "BH", data=combined_gene_metric_per_sample_all_small)
  MUT_SA <- combined_gene_metric_per_sample_all_small[combined_gene_metric_per_sample_all_small$all_genes=="MUT","splicing_antigenicity"]
  WT_SA <- combined_gene_metric_per_sample_all_small[combined_gene_metric_per_sample_all_small$all_genes=="WT","splicing_antigenicity"]
  MUT_VALS<-length(which(combined_gene_metric_per_sample_all_small$all_genes=="MUT"))
  WT_VALS<-length(which(combined_gene_metric_per_sample_all_small$all_genes=="WT"))
  splice_vals[cancer,"MUT_ov_WT"]<-mean(MUT_SA,na.rm=T)/mean(WT_SA,na.rm=T)
  splice_vals[cancer,"MUT_minus_WT"]<-(mean(MUT_SA,na.rm=T) - mean(WT_SA,na.rm=T))/sd(MUT_SA,na.rm=T)
  splice_vals[cancer,"BH_pval"]<-wilcox_test_val$p.adj
  splice_vals[cancer,"MUT_COUNT"] <- MUT_VALS
  splice_vals[cancer,"WT_COUNT"] <- WT_VALS
    
  } else {
    MUT_VALS<-length(which(combined_gene_metric_per_sample_all_small$all_genes=="MUT"))
    WT_VALS<-length(which(combined_gene_metric_per_sample_all_small$all_genes=="WT"))
    splice_vals_MUT_ov_WT[cancer,"MUT_ov_WT"]<-NA
    splice_vals_pvals[cancer,"BH_pval"]<-NA
    splice_vals[cancer,"MUT_COUNT"] <- MUT_VALS
    splice_vals[cancer,"WT_COUNT"] <- WT_VALS
  }
  
  wilcox_test_val <- compare_means(splicing_antigenicity ~ all_genes, p.adjust.method = "BH", data=combined_gene_metric_per_sample_all_small)
  print(ggplot(combined_gene_metric_per_sample_all_small,aes(y=splicing_antigenicity,x=all_genes))+
    geom_boxplot(fill="grey")+geom_violin(alpha=0.2)+
    add_pvalue(wilcox_test_val,label = "p.adj", remove.bracket = TRUE,y.position=max(combined_gene_metric_per_sample_all_small$splicing_antigenicity)+0.01)+
    labs(title=sprintf("%s: MUT=%d WT=%d",cancer,MUT_VALS,WT_VALS))+
    xlab("Mutations in Splicing Machinery")+
    ylab("Splicing Antigenicity"))
    
  for (j in seq(length(splicing_factor_genes))){
    gene <- splicing_factor_genes[j]
    gene_metric_av_gene_df <- data.frame(splicing_antigenicity=combined_gene_metric_per_sample_all_small$splicing_antigenicity,
                                   gene=combined_gene_metric_per_sample_all_small[,gene])
    if (length(unique(gene_metric_av_gene_df$gene))==1){
      a<-c(rep(NA,8),cancer,gene,NA,NA,
           length(gene_metric_av_gene_df$splicing_antigenicity[gene_metric_av_gene_df$gene=="WT"]),
                  length(gene_metric_av_gene_df$splicing_antigenicity[gene_metric_av_gene_df$gene=="MUT"]))
    } else {
      a<-compare_means(splicing_antigenicity~gene,data=gene_metric_av_gene_df)
      a$cancer <- cancer
      a$gene <- gene
      a$mut_ov_wt <- mean(gene_metric_av_gene_df$splicing_antigenicity[gene_metric_av_gene_df$gene=="MUT"],na.rm=T)/mean(gene_metric_av_gene_df$splicing_antigenicity[gene_metric_av_gene_df$gene=="WT"],na.rm=T)
      a$mut_wt_EZ <- (mean(gene_metric_av_gene_df$splicing_antigenicity[gene_metric_av_gene_df$gene=="MUT"],na.rm=T) - mean(gene_metric_av_gene_df$splicing_antigenicity[gene_metric_av_gene_df$gene=="WT"],na.rm=T)) / sd(gene_metric_av_gene_df$splicing_antigenicity[gene_metric_av_gene_df$gene=="MUT"],na.rm=T)

      a$WT_NUM <- length(gene_metric_av_gene_df$splicing_antigenicity[gene_metric_av_gene_df$gene=="WT"])
      a$MUT_NUM <- length(gene_metric_av_gene_df$splicing_antigenicity[gene_metric_av_gene_df$gene=="MUT"])
      a<-data.frame(a)
    }
    if (i == 1){
      all_comps <- a
    } else {
      all_comps <- rbind(all_comps,a)
    }
  }
}

for (j in seq(length(splicing_factor_genes))){
  gene <- splicing_factor_genes[j]
  gene_metric_av_gene_df <- data.frame(splicing_antigenicity=combined_gene_metric_per_sample_all$splicing_antigenicity,
                                 gene=combined_gene_metric_per_sample_all[,gene])
  if (length(unique(gene_metric_av_gene_df$gene))==1){
    a<-rep(NA,14)
  } else {
    a<-compare_means(splicing_antigenicity~gene,data=gene_metric_av_gene_df)
    a$cancer <- "all"
    a$gene <- gene
    a$mut_ov_wt <- mean(gene_metric_av_gene_df$splicing_antigenicity[gene_metric_av_gene_df$gene=="MUT"],na.rm=T)/mean(gene_metric_av_gene_df$splicing_antigenicity[gene_metric_av_gene_df$gene=="WT"],na.rm=T)
      a$mut_wt_EZ <- (mean(gene_metric_av_gene_df$splicing_antigenicity[gene_metric_av_gene_df$gene=="MUT"],na.rm=T) - mean(gene_metric_av_gene_df$splicing_antigenicity[gene_metric_av_gene_df$gene=="WT"],na.rm=T)) / sd(gene_metric_av_gene_df$splicing_antigenicity[gene_metric_av_gene_df$gene=="MUT"],na.rm=T)
    a$WT_NUM <- length(gene_metric_av_gene_df$splicing_antigenicity[gene_metric_av_gene_df$gene=="WT"])
    a$MUT_NUM <- length(gene_metric_av_gene_df$splicing_antigenicity[gene_metric_av_gene_df$gene=="MUT"])
    a<-data.frame(a)
  }
  if (j == 1){
    all_comps_all_samples <- a
  } else {
    all_comps_all_samples <- rbind(all_comps_all_samples,a)
  }
}

colnames(splice_vals)<-c("cancer","MUT_ov_WT","MUT_minus_WT_EZ","BH_pvals","MUT_COUNT","WT_COUNT")

ggplot(splice_vals,aes(x=log2(MUT_ov_WT),y=-log10(BH_pvals),color=sprintf("%s:%d/%d",cancer,MUT_COUNT,WT_COUNT),label=cancer))+
  geom_point()+
  geom_text_repel()+
  geom_hline(yintercept=-log10(0.05))+
  labs(color="cancer: MUT_count/WT_count")+
  xlab("log2(mut. sample SA / WT sample SA)")

ggplot(combined_gene_metric_per_sample_all,aes(x=all_genes,y=splicing_antigenicity))+
  facet_grid(~cancer)+
  geom_boxplot()+
  add_pvalue(wilcox_test_val_all,label = "p.signif", remove.bracket = TRUE,
             y.position=max(combined_gene_metric_per_sample_all$splicing_antigenicity)+0.01)+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(splice_vals,aes(y=MUT_minus_WT_EZ,x=cancer))+
  geom_bar(stat="identity")+
  xlab("cancer")+
  ylab("Effect Size")

saveRDS(all_comps_all_samples,
          file=mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/SF_all_comparisons_all_samples.rds"))
write.csv(all_comps_all_samples,
          file=mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/SF_all_comparisons_all_samples.csv"))
saveRDS(all_comps,
          file=mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/SF_all_comparisons.rds"))
write.csv(all_comps,
          file=mod_path("/mnt/f/TCGA_junctions/splicemutr_paper_supplement_data/SF_all_comparisons.csv"))

```

# Citations

1. Immunity. Volume 48 p1-19, 17 April 2018 10.1016/j.immuni.2018.03.023
2. Seiler, Michael et al. Somatic Mutational Landscape of Splicing Factor Genes and Their Functional Consequences across 33 Cancer Types. Cell reports vol. 23,1 (2018): 282-296.e4. doi:10.1016/j.celrep.2018.01.088